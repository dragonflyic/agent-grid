name: Infrastructure

on:
  push:
    branches: [main]
    paths:
      - "infrastructure/terraform/**"
      - "digger.yml"
  pull_request:
    branches: [main]
    paths:
      - "infrastructure/terraform/**"
      - "digger.yml"
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      spec:
        required: false
      run_name:
        required: false

env:
  TF_VAR_database_password: ${{ secrets.TF_VAR_DATABASE_PASSWORD }}
  TF_VAR_github_token: ${{ secrets.TF_VAR_GITHUB_TOKEN }}
  TF_VAR_github_webhook_secret: ${{ secrets.TF_VAR_GITHUB_WEBHOOK_SECRET }}
  TF_VAR_github_org: ${{ vars.TF_VAR_GITHUB_ORG }}
  TF_VAR_fly_api_token: ${{ secrets.FLY_API_TOKEN }}
  TF_VAR_anthropic_api_key: ${{ secrets.TF_VAR_ANTHROPIC_API_KEY }}
  TF_VAR_target_repo: ${{ vars.TF_VAR_TARGET_REPO }}

jobs:
  digger:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    permissions:
      contents: write
      actions: write
      id-token: write
      pull-requests: write
      issues: read
      statuses: write

    steps:
      - uses: actions/checkout@v4

      - name: digger run
        if: github.event_name != 'push'
        uses: diggerhq/digger@vLatest
        with:
          no-backend: true
          disable-locking: true
          setup-aws: true
          aws-role-to-assume: arn:aws:iam::796973497082:role/github-actions-terraform
          aws-region: us-west-2
          setup-opentofu: true
          opentofu-version: 1.9.0
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        if: github.event_name == 'push'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::796973497082:role/github-actions-terraform
          aws-region: us-west-2

      - name: Setup OpenTofu
        if: github.event_name == 'push'
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.9.0

      - name: Tofu Apply
        if: github.event_name == 'push'
        working-directory: infrastructure/terraform/environments/dev
        run: |
          tofu init
          tofu apply -auto-approve
